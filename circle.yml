machine:
  pre:
    # Use CircleCI's beta of Docker 1.10
    #
    # See https://discuss.circleci.com/t/circle-ci-and-docker-compose-version-2-yaml-syntax/4708/4
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  environment:
    STREAK_CLUB_PIPELINE_KEY: clubs
    STREAK_LEADER_PIPELINE_KEY: leaders
    STREAK_API_KEY: test_api_key

dependencies:
  pre:
    # Install the latest Docker Compose so we can use the v2 docker-compose.yml
    # syntax
    #
    # See https://discuss.circleci.com/t/circle-ci-and-docker-compose-version-2-yaml-syntax/4708/4
    - sudo pip install docker-compose
  override:
    # Print info about the current Docker setup to make debugging easier
    - docker info

    # Build the images
    - PWD=$HOME/api docker-compose build

    # Install dependencies into the bundle image
    - PWD=$HOME/api docker-compose run web bundle install

database:
  override:
    - PWD=$HOME/api docker-compose run web rails db:create db:migrate --trace

test:
  override:
    # This is a horrible hack that modifies docker-compose.yml to mount
    # $CIRCLE_TEST_REPORTS to /tmp/test_reports on all services that have any
    # volumes.
    - PWD=$HOME/api perl -pi -e "s/volumes:/volumes:\n      - $(echo $CIRCLE_TEST_REPORTS | sed 's/\//\\\//g'):\/tmp\/test_reports/" docker-compose.yml

    # Run the tests!
    - PWD=$HOME/api docker-compose run -e RAILS_ENV=test -e CODECLIMATE_REPO_TOKEN=$CODECLIMATE_REPO_TOKEN web bundle exec rspec -r rspec_junit_formatter --format RspecJunitFormatter -o /tmp/test_reports/rspec/junit.xml

deployment:
  production:
    branch: master
    commands:
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push git@heroku.com:api-hackclub.git $CIRCLE_SHA1:refs/heads/master
      - heroku run rake db:migrate --app api-hackclub:
          timeout: 400 # if your deploys take a long time
